# ğŸ”§ æ ªç©´ï¼ˆkabu-anaï¼‰æŠ€è¡“ä»•æ§˜æ›¸

## ğŸ“‹ æ¦‚è¦

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: æ ªç©´ï¼ˆkabu-anaï¼‰- AIæ ªå¼åˆ†æã‚«ãƒ«ãƒ†  
**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: Next.js 14.2.3 + TypeScript + Firebase  
**å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶**: Chrome, Firefox, Safari, Edgeï¼ˆæœ€æ–°ç‰ˆï¼‰  
**å¯¾å¿œãƒ‡ãƒã‚¤ã‚¹**: PC, ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ, ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (Next.js)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Login/LP    â”‚  â”‚ Dashboard   â”‚  â”‚ Karte       â”‚        â”‚
â”‚  â”‚ (/login)    â”‚  â”‚ (/dashboard)â”‚  â”‚ (/karte)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Authentication Layer                     â”‚
â”‚                  (Firebase Authentication)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      API Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Auth API    â”‚  â”‚ Analysis    â”‚  â”‚ User Data   â”‚        â”‚
â”‚  â”‚             â”‚  â”‚ API         â”‚  â”‚ API         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Backend Services                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Firestore   â”‚  â”‚ AI APIs     â”‚  â”‚ Stock APIs  â”‚        â”‚
â”‚  â”‚ Database    â”‚  â”‚ (OpenAI/    â”‚  â”‚ (Alpha      â”‚        â”‚
â”‚  â”‚             â”‚  â”‚ Claude/     â”‚  â”‚ Vantage)    â”‚        â”‚
â”‚  â”‚             â”‚  â”‚ Gemini)     â”‚  â”‚             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

### ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

```
kabu-anal/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ globals.css                 # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”œâ”€â”€ layout.tsx                  # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”œâ”€â”€ page.tsx                    # ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆç¾åœ¨ï¼‰
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ ai-analysis/
â”‚   â”‚       â””â”€â”€ route.ts            # AIåˆ†æAPI
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ AIKarteDisplay.tsx      # ã‚«ãƒ«ãƒ†è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ MockKarteData.ts        # ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
â”‚   â”‚   â””â”€â”€ UnderDevelopment.tsx    # é–‹ç™ºä¸­è¡¨ç¤º
â”‚   â”œâ”€â”€ karte/
â”‚   â”‚   â”œâ”€â”€ page.tsx                # ã‚«ãƒ«ãƒ†ãƒšãƒ¼ã‚¸
â”‚   â”‚   â”œâ”€â”€ SearchableKarte.tsx     # æ¤œç´¢æ©Ÿèƒ½ä»˜ãã‚«ãƒ«ãƒ†
â”‚   â”‚   â””â”€â”€ demo/
â”‚   â”‚       â””â”€â”€ page.tsx            # ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ firebase.ts             # Firebaseè¨­å®š
â”‚   â”‚   â””â”€â”€ aiPrompts.ts            # AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©
â”‚   â””â”€â”€ [ãã®ä»–æ©Ÿèƒ½ãƒšãƒ¼ã‚¸]/
â”œâ”€â”€ public/                         # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ package.json                    # ä¾å­˜é–¢ä¿‚
â”œâ”€â”€ next.config.js                  # Next.jsè¨­å®š
â”œâ”€â”€ tsconfig.json                   # TypeScriptè¨­å®š
â”œâ”€â”€ firebase.json                   # Firebaseè¨­å®š
â”œâ”€â”€ firestore.rules                 # Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
â”œâ”€â”€ firestore.indexes.json          # Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
â””â”€â”€ vercel.json                     # Vercelè¨­å®š
```

### è¿½åŠ äºˆå®šã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

```
app/
â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ page.tsx                    # ãƒ­ã‚°ã‚¤ãƒ³/LPãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ LoginForm.tsx           # ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
â”‚       â”œâ”€â”€ LandingHero.tsx         # ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
â”‚       â””â”€â”€ FeatureSection.tsx      # æ©Ÿèƒ½ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ page.tsx                    # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ UserStats.tsx           # ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ
â”‚       â”œâ”€â”€ RecentAnalyses.tsx      # æœ€è¿‘ã®åˆ†æ
â”‚       â”œâ”€â”€ FavoriteStocks.tsx      # ãŠæ°—ã«å…¥ã‚ŠéŠ˜æŸ„
â”‚       â””â”€â”€ MarketOverview.tsx      # å¸‚å ´æ¦‚æ³
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ Header.tsx              # å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx             # ã‚µã‚¤ãƒ‰ãƒãƒ¼
â”‚   â”‚   â”œâ”€â”€ Footer.tsx              # ãƒ•ãƒƒã‚¿ãƒ¼
â”‚   â”‚   â””â”€â”€ LoadingSpinner.tsx      # ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ AuthProvider.tsx        # èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
â”‚   â”‚   â”œâ”€â”€ ProtectedRoute.tsx      # èªè¨¼ä¿è­·ãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ UserMenu.tsx            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ Button.tsx              # ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚       â”œâ”€â”€ Modal.tsx               # ãƒ¢ãƒ¼ãƒ€ãƒ«
â”‚       â””â”€â”€ Toast.tsx               # ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAuth.ts                  # èªè¨¼ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useFirestore.ts             # Firestoreãƒ•ãƒƒã‚¯
â”‚   â””â”€â”€ useAnalysis.ts              # åˆ†æãƒ•ãƒƒã‚¯
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ constants.ts                # å®šæ•°å®šç¾©
â”‚   â”œâ”€â”€ helpers.ts                  # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
â”‚   â””â”€â”€ validation.ts               # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â””â”€â”€ types/
    â”œâ”€â”€ auth.ts                     # èªè¨¼é–¢é€£å‹å®šç¾©
    â”œâ”€â”€ analysis.ts                 # åˆ†æé–¢é€£å‹å®šç¾©
    â””â”€â”€ user.ts                     # ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£å‹å®šç¾©
```

## ğŸ”§ æŠ€è¡“ä»•æ§˜è©³ç´°

### Next.js è¨­å®š

#### next.config.js

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    appDir: true,
  },
  images: {
    domains: [
      "lh3.googleusercontent.com", // Google ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
      "firebasestorage.googleapis.com", // Firebase Storage
    ],
  },
  env: {
    CUSTOM_KEY: process.env.CUSTOM_KEY,
  },
  async headers() {
    return [
      {
        source: "/api/:path*",
        headers: [
          { key: "Access-Control-Allow-Origin", value: "*" },
          {
            key: "Access-Control-Allow-Methods",
            value: "GET, POST, PUT, DELETE, OPTIONS",
          },
          {
            key: "Access-Control-Allow-Headers",
            value: "Content-Type, Authorization",
          },
        ],
      },
    ];
  },
};

module.exports = nextConfig;
```

#### tsconfig.json

```json
{
  "compilerOptions": {
    "target": "es2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"],
      "@/app/*": ["./app/*"],
      "@/components/*": ["./app/components/*"],
      "@/lib/*": ["./app/lib/*"],
      "@/types/*": ["./app/types/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### Firebase è¨­å®š

#### firebase.json

```json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "out",
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "storage": {
    "rules": "storage.rules"
  }
}
```

#### firestore.rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // åˆ†æå±¥æ­´
    match /analyses/{analysisId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // ãŠæ°—ã«å…¥ã‚Š
    match /favorites/{favoriteId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ
    match /user_stats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // å…¬é–‹ãƒ‡ãƒ¼ã‚¿ï¼ˆå¸‚å ´æƒ…å ±ç­‰ï¼‰
    match /public/{document=**} {
      allow read: if true;
      allow write: if request.auth != null &&
        request.auth.token.admin == true;
    }

    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
    match /system/{document=**} {
      allow read, write: if request.auth != null &&
        request.auth.token.admin == true;
    }
  }
}
```

#### firestore.indexes.json

```json
{
  "indexes": [
    {
      "collectionGroup": "analyses",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "userId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "favorites",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "userId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "addedAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "analyses",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "stockCode",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}
```

## ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

### Firebase Authentication è¨­å®š

#### app/lib/auth.ts

```typescript
import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signInWithPopup,
  GoogleAuthProvider,
  signOut,
  onAuthStateChanged,
  User,
  sendPasswordResetEmail,
  updateProfile,
} from "firebase/auth";
import { doc, setDoc, getDoc, updateDoc } from "firebase/firestore";
import { auth, db } from "./firebase";

// Googleèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
const googleProvider = new GoogleAuthProvider();
googleProvider.setCustomParameters({
  prompt: "select_account",
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å‹å®šç¾©
export interface UserProfile {
  uid: string;
  email: string;
  displayName: string;
  photoURL?: string;
  plan: "free" | "premium";
  createdAt: Date;
  lastLoginAt: Date;
  preferences: {
    theme: "light" | "dark";
    language: "ja" | "en";
    notifications: boolean;
  };
}

// ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
export const signInWithEmail = async (email: string, password: string) => {
  try {
    const result = await signInWithEmailAndPassword(auth, email, password);
    await updateLastLogin(result.user.uid);
    return result;
  } catch (error) {
    throw error;
  }
};

// ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ–°è¦ç™»éŒ²
export const signUpWithEmail = async (
  email: string,
  password: string,
  displayName: string
) => {
  try {
    const result = await createUserWithEmailAndPassword(auth, email, password);

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
    await updateProfile(result.user, { displayName });

    // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
    await createUserProfile(result.user, { displayName });

    return result;
  } catch (error) {
    throw error;
  }
};

// Googleã§ãƒ­ã‚°ã‚¤ãƒ³
export const signInWithGoogle = async () => {
  try {
    const result = await signInWithPopup(auth, googleProvider);

    // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆ
    const userDoc = await getDoc(doc(db, "users", result.user.uid));
    if (!userDoc.exists()) {
      await createUserProfile(result.user);
    } else {
      await updateLastLogin(result.user.uid);
    }

    return result;
  } catch (error) {
    throw error;
  }
};

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
export const logout = async () => {
  try {
    await signOut(auth);
  } catch (error) {
    throw error;
  }
};

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
export const resetPassword = async (email: string) => {
  try {
    await sendPasswordResetEmail(auth, email);
  } catch (error) {
    throw error;
  }
};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆ
const createUserProfile = async (
  user: User,
  additionalData?: { displayName?: string }
) => {
  const userProfile: UserProfile = {
    uid: user.uid,
    email: user.email!,
    displayName: additionalData?.displayName || user.displayName || "",
    photoURL: user.photoURL || undefined,
    plan: "free",
    createdAt: new Date(),
    lastLoginAt: new Date(),
    preferences: {
      theme: "light",
      language: "ja",
      notifications: true,
    },
  };

  await setDoc(doc(db, "users", user.uid), userProfile);

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®åˆæœŸåŒ–
  await setDoc(doc(db, "user_stats", user.uid), {
    totalAnalyses: 0,
    favoriteCount: 0,
    lastAnalysisAt: null,
    monthlyUsage: {},
  });
};

// æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»æ›´æ–°
const updateLastLogin = async (uid: string) => {
  await updateDoc(doc(db, "users", uid), {
    lastLoginAt: new Date(),
  });
};

// èªè¨¼çŠ¶æ…‹ç›£è¦–
export const onAuthStateChange = (callback: (user: User | null) => void) => {
  return onAuthStateChanged(auth, callback);
};
```

### èªè¨¼ãƒ•ãƒƒã‚¯

#### app/hooks/useAuth.ts

```typescript
'use client';

import { useState, useEffect, useContext, createContext } from 'react';
import { User } from 'firebase/auth';
import { doc, onSnapshot } from 'firebase/firestore';
import { onAuthStateChange } from '@/lib/auth';
import { db } from '@/lib/firebase';
import { UserProfile } from '@/lib/auth';

interface AuthContextType {
  user: User | null;
  userProfile: UserProfile | null;
  loading: boolean;
  error: string | null;
}

const AuthContext = createContext<AuthContextType>({
  user: null,
  userProfile: null,
  loading: true,
  error: null
});

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const unsubscribe = onAuthStateChange((user) => {
      setUser(user);
      setLoading(false);

      if (user) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        const unsubscribeProfile = onSnapshot(
          doc(db, 'users', user.uid),
          (doc) => {
            if (doc.exists()) {
              setUserProfile(doc.data() as UserProfile);
            }
          },
          (error) => {
            setError(error.message);
          }
        );

        return () => unsubscribeProfile();
      } else {
        setUserProfile(null);
      }
    });

    return () => unsubscribe();
  }, []);

  return (
    <AuthContext.Provider value={{ user, userProfile, loading, error }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆè©³ç´°

### Firestore ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä»•æ§˜

#### users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface User {
  uid: string; // Firebase Auth UID
  email: string; // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  displayName: string; // è¡¨ç¤ºå
  photoURL?: string; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL
  plan: "free" | "premium"; // ãƒ—ãƒ©ãƒ³
  createdAt: Timestamp; // ä½œæˆæ—¥æ™‚
  lastLoginAt: Timestamp; // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚
  preferences: {
    theme: "light" | "dark"; // ãƒ†ãƒ¼ãƒ
    language: "ja" | "en"; // è¨€èª
    notifications: boolean; // é€šçŸ¥è¨­å®š
  };
}
```

#### analyses ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface Analysis {
  id: string; // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
  userId: string; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  stockCode: string; // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰
  stockName: string; // éŠ˜æŸ„å
  market: "JP" | "US"; // å¸‚å ´
  analysisData: {
    stockInfo: {
      code: string;
      name: string;
      market: string;
      currentPrice: number;
      priceChange: number;
      priceChangePercent: number;
    };
    companyOverview: {
      description: string;
      industry: string;
      sector: string;
      employees: number;
      founded: string;
      headquarters: string;
      website: string;
    };
    metrics: {
      per: number;
      pbr: number;
      roe: number;
      roa: number;
      dividendYield: number;
      marketCap: number;
    };
    aiScore: {
      overall: number;
      growth: number;
      profitability: number;
      stability: number;
      valuation: number;
    };
    // ... ãã®ä»–ã®åˆ†æãƒ‡ãƒ¼ã‚¿
  };
  createdAt: Timestamp; // ä½œæˆæ—¥æ™‚
  isPublic: boolean; // å…¬é–‹è¨­å®š
  tags?: string[]; // ã‚¿ã‚°
}
```

#### favorites ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface Favorite {
  id: string; // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
  userId: string; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  stockCode: string; // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰
  stockName: string; // éŠ˜æŸ„å
  market: "JP" | "US"; // å¸‚å ´
  addedAt: Timestamp; // è¿½åŠ æ—¥æ™‚
  notes?: string; // ãƒ¡ãƒ¢
}
```

#### user_stats ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface UserStats {
  userId: string; // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼‰
  totalAnalyses: number; // ç·åˆ†æå›æ•°
  favoriteCount: number; // ãŠæ°—ã«å…¥ã‚Šæ•°
  lastAnalysisAt: Timestamp | null; // æœ€çµ‚åˆ†ææ—¥æ™‚
  monthlyUsage: {
    [yearMonth: string]: {
      // 'YYYY-MM' å½¢å¼
      analyses: number; // æœˆé–“åˆ†æå›æ•°
      favorites: number; // æœˆé–“ãŠæ°—ã«å…¥ã‚Šè¿½åŠ æ•°
    };
  };
  streakDays: number; // é€£ç¶šåˆ©ç”¨æ—¥æ•°
  achievements: string[]; // é”æˆãƒãƒƒã‚¸
}
```

## ğŸ¨ UI/UXã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### Button ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// app/components/ui/Button.tsx
interface ButtonProps {
  variant: 'primary' | 'secondary' | 'outline' | 'ghost';
  size: 'sm' | 'md' | 'lg';
  disabled?: boolean;
  loading?: boolean;
  onClick?: () => void;
  children: React.ReactNode;
  className?: string;
}

export const Button: React.FC<ButtonProps> = ({
  variant = 'primary',
  size = 'md',
  disabled = false,
  loading = false,
  onClick,
  children,
  className = ''
}) => {
  const baseClasses = 'font-medium rounded-lg transition-all duration-200 focus:outline-none focus:ring-2';

  const variantClasses = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
    secondary: 'bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500',
    outline: 'border-2 border-blue-600 text-blue-600 hover:bg-blue-50 focus:ring-blue-500',
    ghost: 'text-blue-600 hover:bg-blue-50 focus:ring-blue-500'
  };

  const sizeClasses = {
    sm: 'px-3 py-1.5 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg'
  };

  return (
    <button
      className={`${baseClasses} ${variantClasses[variant]} ${sizeClasses[size]} ${className} ${
        disabled || loading ? 'opacity-50 cursor-not-allowed' : ''
      }`}
      disabled={disabled || loading}
      onClick={onClick}
    >
      {loading && <LoadingSpinner size="sm" className="mr-2" />}
      {children}
    </button>
  );
};
```

#### Modal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// app/components/ui/Modal.tsx
interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  children: React.ReactNode;
  size?: 'sm' | 'md' | 'lg' | 'xl';
}

export const Modal: React.FC<ModalProps> = ({
  isOpen,
  onClose,
  title,
  children,
  size = 'md'
}) => {
  if (!isOpen) return null;

  const sizeClasses = {
    sm: 'max-w-md',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl'
  };

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto">
      <div className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div
          className="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75"
          onClick={onClose}
        />

        <div className={`inline-block w-full ${sizeClasses[size]} p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-2xl`}>
          {title && (
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-medium text-gray-900">{title}</h3>
              <button
                onClick={onClose}
                className="text-gray-400 hover:text-gray-600"
              >
                âœ•
              </button>
            </div>
          )}
          {children}
        </div>
      </div>
    </div>
  );
};
```

## ğŸ”Œ APIè¨­è¨ˆ

### AIåˆ†æAPIæ‹¡å¼µ

#### app/api/ai-analysis/route.tsï¼ˆæ‹¡å¼µç‰ˆï¼‰

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { doc, setDoc, updateDoc, increment } from "firebase/firestore";
import { db } from "@/lib/firebase";

export async function POST(request: NextRequest) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await getServerSession();
    if (!session?.user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { stockCode, market, step, previousData } = await request.json();

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    const canAnalyze = await checkRateLimit(session.user.id);
    if (!canAnalyze) {
      return NextResponse.json(
        { error: "Rate limit exceeded" },
        { status: 429 }
      );
    }

    let result;

    switch (step) {
      case 1:
        result = await identifyCompany(stockCode, market);
        break;
      case 2:
        result = await fetchStockPrice(stockCode, market, previousData);
        break;
      case 3:
        result = await performDetailedAnalysis(stockCode, market, previousData);

        // åˆ†æçµæœã‚’Firestoreã«ä¿å­˜
        await saveAnalysisResult(session.user.id, {
          stockCode,
          market,
          analysisData: result,
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã‚’æ›´æ–°
        await updateUserStats(session.user.id);
        break;
      default:
        return NextResponse.json({ error: "Invalid step" }, { status: 400 });
    }

    return NextResponse.json(result);
  } catch (error) {
    console.error("AI Analysis Error:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
async function checkRateLimit(userId: string): Promise<boolean> {
  // å®Ÿè£…: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœˆé–“åˆ©ç”¨å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯æœˆ5å›ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¯ç„¡åˆ¶é™
  return true; // ç°¡ç•¥åŒ–
}

// åˆ†æçµæœä¿å­˜
async function saveAnalysisResult(userId: string, analysisData: any) {
  const analysisId = `${userId}_${Date.now()}`;
  await setDoc(doc(db, "analyses", analysisId), {
    userId,
    ...analysisData,
    createdAt: new Date(),
    isPublic: false,
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæ›´æ–°
async function updateUserStats(userId: string) {
  const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM

  await updateDoc(doc(db, "user_stats", userId), {
    totalAnalyses: increment(1),
    lastAnalysisAt: new Date(),
    [`monthlyUsage.${currentMonth}.analyses`]: increment(1),
  });
}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿API

#### app/api/user/profile/route.ts

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { doc, getDoc, updateDoc } from 'firebase/firestore';
import { db } from '@/lib/firebase';

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const userDoc = await getDoc(doc(db, 'users', session.user.id));
    if (!userDoc.exists()) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 });
    }

    return NextResponse.json(userDoc.data());
  } catch (error) {
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
export async function PUT(request: NextRequest) {
  try {
    const session = await
```
