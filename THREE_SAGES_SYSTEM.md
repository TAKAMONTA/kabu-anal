# 市場三賢人システム - 実装ドキュメント

## 概要

このシステムは、Perplexityによる統一データ収集と、3つのAI（Gemini、Claude、OpenAI）による専門分析を統合した株式分析システムです。

## システムアーキテクチャ

### Phase 1: データ収集（Perplexity）

- **エンドポイント**: `/api/collect-data`
- **役割**: 最新の市場データを信頼できる情報源から収集
- **出力**: 統一フォーマットのJSON

### Phase 2: 並列AI分析

1. **Gemini賢人** (`/api/analyze-gemini`)
   - 専門分野: テクニカル分析
   - チャートパターン、移動平均線、RSI、MACDなどを分析

2. **Claude賢人** (`/api/analyze-claude`)
   - 専門分野: ファンダメンタル分析
   - PER、PBR、ROE、財務健全性、成長性を分析

3. **OpenAI賢人** (`/api/analyze-openai`)
   - 専門分野: 総合判断
   - テクニカル×ファンダメンタルを統合し、投資判断を提示

### Phase 3: 結果統合

- **エンドポイント**: `/api/three-sages-analysis`
- **役割**: 3つのAI分析を統合し、総合判断を生成

## API仕様

### 1. データ収集API

```typescript
POST /api/collect-data
{
  "stockCode": "9501"
}

// レスポンス
{
  "success": true,
  "data": {
    "metadata": {
      "証券コード": "9501",
      "企業名": "東京電力ホールディングス",
      "収集日時": "2025-01-01T10:00:00+09:00",
      "データ信頼度": "高"
    },
    "株価情報": {
      "現在値": 3750,
      "前日比": { "円": 42, "パーセント": 1.13 },
      "出来高": 1250000,
      "時価総額": "1兆2000億円",
      "情報源": "https://..."
    },
    "財務指標": { ... },
    "テクニカル指標": { ... },
    "最新ニュース": [ ... ]
  }
}
```

### 2. AI分析API（共通フォーマット）

```typescript
POST /api/analyze-gemini  // または analyze-claude, analyze-openai
{
  "unifiedData": { /* 統一データ */ }
}

// レスポンス
{
  "success": true,
  "result": {
    "AI名": "Gemini賢人",
    "専門分野": "テクニカル分析",
    "推奨の見立て": "買い",
    "信頼度": 75,
    "分析内容": { ... },
    "リスク要因": [ ... ],
    "目標株価": { "下限": 3450, "上限": 3900 }
  }
}
```

### 3. 統合オーケストレーターAPI

```typescript
POST /api/three-sages-analysis
{
  "stockCode": "9501"
}

// レスポンス
{
  "success": true,
  "data": {
    "証券コード": "9501",
    "企業名": "東京電力ホールディングス",
    "統一データ": { ... },
    "分析結果": {
      "Gemini": { ... },
      "Claude": { ... },
      "OpenAI": { ... }
    },
    "総合判断": {
      "判断": "買い",
      "信頼度": 77,
      "理由": "3つのAIのうち2つが買いを推奨しています。",
      "詳細": {
        "買い推奨": 2,
        "売り推奨": 0,
        "保留推奨": 1
      },
      "目標株価統合": {
        "下限": 3450,
        "上限": 4100,
        "平均下限": 3533,
        "平均上限": 4000
      }
    }
  }
}
```

## フロントエンド

### アクセス方法

```
http://localhost:3000/three-sages
```

### 機能

1. **証券コード入力**: 4桁の日本株式コードを入力
2. **リアルタイム進捗表示**: Phase 1 → Phase 2 → Phase 3
3. **統一データ表示**: 現在値、前日比、PER、PBR、ROE
4. **3つのAIカード**: 各賢人の専門分析を並列表示
5. **総合判断**: 買い/売り/保留の最終判断と信頼度

## 開発サーバーの起動

```bash
npm run dev
```

アクセス: http://localhost:3000/three-sages

## テスト手順

### 1. APIテスト（個別）

```bash
# データ収集テスト
curl -X POST http://localhost:3000/api/collect-data \
  -H "Content-Type: application/json" \
  -d '{"stockCode":"9501"}'

# Gemini分析テスト（統一データが必要）
curl -X POST http://localhost:3000/api/analyze-gemini \
  -H "Content-Type: application/json" \
  -d '{"unifiedData":{...}}'
```

### 2. 統合テスト

```bash
# フル分析実行
curl -X POST http://localhost:3000/api/three-sages-analysis \
  -H "Content-Type: application/json" \
  -d '{"stockCode":"9501"}'
```

### 3. UIテスト

1. http://localhost:3000/three-sages にアクセス
2. 証券コード「9501」を入力
3. 「分析開始」ボタンをクリック
4. 各Phaseの進行を確認
5. 結果が正しく表示されることを確認

## 推奨テスト銘柄

- **9501**: 東京電力ホールディングス
- **7203**: トヨタ自動車
- **9984**: ソフトバンクグループ
- **6758**: ソニーグループ

## エラーハンドリング

システムは各Phaseでエラーが発生した場合、適切なエラーメッセージを返します：

- **Phase 1エラー**: Perplexityのデータ取得失敗
- **Phase 2エラー**: いずれかのAI分析失敗
- **Phase 3エラー**: 結果統合失敗

## 環境変数

必要なAPI キー（.env.local）:

```env
PERPLEXITY_API_KEY=pplx-...
GEMINI_API_KEY=AIza...
CLAUDE_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-proj-...
```

## システムの特徴

### ✅ 実装済み機能

1. **統一データ収集**: Perplexityによる正確な市場データ取得
2. **専門分析**: 3つのAIがそれぞれの専門分野で分析
3. **並列処理**: Phase 2で3つのAIを同時実行
4. **総合判断**: 多数決と信頼度による最終判断
5. **リアルタイムUI**: 進捗状況を視覚的に表示
6. **エラーハンドリング**: 各Phaseでの適切なエラー処理

### 🎯 システムの利点

1. **データの一貫性**: すべてのAIが同じデータを使用
2. **専門性の活用**: 各AIが得意分野に特化
3. **多角的分析**: テクニカル、ファンダメンタル、総合の3視点
4. **透明性**: 各AIの判断根拠が明確
5. **拡張性**: 新しいAIや分析手法を追加しやすい

## トラブルシューティング

### API呼び出しエラー

```
Error: PERPLEXITY_API_KEY が設定されていません
→ .env.local を確認し、APIキーが正しく設定されているか確認
```

### データ取得エラー

```
Error: JSONデータの抽出に失敗しました
→ Perplexityのレスポンスが期待するフォーマットではない
→ 証券コードが正しいか確認
```

### AI分析エラー

```
Error: Gemini分析中にエラーが発生しました
→ 統一データが正しく渡されているか確認
→ APIキーの有効性を確認
```

## パフォーマンス

- **Phase 1**: 約5-10秒（Perplexityのデータ収集）
- **Phase 2**: 約10-15秒（3つのAI並列分析）
- **Phase 3**: 約1秒（結果統合）
- **合計**: 約16-26秒

## セキュリティ

1. APIキーは環境変数で管理
2. サーバーサイドでのみAPI呼び出し
3. フロントエンドにAPIキーを露出しない
4. レート制限の実装（今後の改善点）

## 今後の拡張案

1. **履歴機能**: 過去の分析結果を保存
2. **比較機能**: 複数銘柄の比較分析
3. **アラート機能**: 目標株価到達時の通知
4. **PDF出力**: 分析レポートのダウンロード
5. **リアルタイム更新**: WebSocketによる自動更新

## まとめ

この市場三賢人システムは、統一データに基づく信頼性の高い株式分析を提供します。各AIの専門性を活かしつつ、総合的な投資判断をサポートします。
